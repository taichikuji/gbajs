<!DOCTYPE html>
<html>
<head>
<title>Save Functionality Test</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
.test { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
.pass { background-color: #d4edda; }
.fail { background-color: #f8d7da; }
.info { background-color: #d1ecf1; }
pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
</style>
</head>
<body>
<h1>GBA.js Save Functionality Tests</h1>
<div id="results"></div>

<script>
var results = [];

function log(message, type) {
    type = type || 'info';
    results.push({ message: message, type: type });
}

function runTests() {
    // Test 1: Check localStorage availability
    log('=== Test 1: localStorage Availability ===');
    try {
        if (typeof localStorage !== 'undefined') {
            localStorage.setItem('test', 'value');
            localStorage.removeItem('test');
            log('✓ localStorage is available', 'pass');
        } else {
            log('✗ localStorage is not available', 'fail');
        }
    } catch (e) {
        log('✗ localStorage error: ' + e.message, 'fail');
    }

    // Test 2: Base64 encoding/decoding
    log('\n=== Test 2: Base64 Encoding ===');
    try {
        var testData = new Uint8Array([1, 2, 3, 4, 5]);
        var encoded = btoa(String.fromCharCode.apply(null, testData));
        log('✓ Base64 encoding works: ' + encoded, 'pass');
        
        var decoded = atob(encoded);
        var decodedArray = new Uint8Array(decoded.length);
        for (var i = 0; i < decoded.length; i++) {
            decodedArray[i] = decoded.charCodeAt(i);
        }
        if (decodedArray[0] === 1 && decodedArray[4] === 5) {
            log('✓ Base64 decoding works correctly', 'pass');
        } else {
            log('✗ Base64 decoding failed', 'fail');
        }
    } catch (e) {
        log('✗ Base64 error: ' + e.message, 'fail');
    }

    // Test 3: localStorage capacity
    log('\n=== Test 3: localStorage Write Test ===');
    try {
        var testKey = 'com.endrift.gbajs.TEST';
        var testValue = 'A'.repeat(1000); // 1KB test
        localStorage.setItem(testKey, testValue);
        var retrieved = localStorage.getItem(testKey);
        if (retrieved === testValue) {
            log('✓ Can write and read from localStorage', 'pass');
        } else {
            log('✗ localStorage read/write mismatch', 'fail');
        }
        localStorage.removeItem(testKey);
    } catch (e) {
        log('✗ localStorage write error: ' + e.message, 'fail');
    }

    // Test 4: FileReader API
    log('\n=== Test 4: FileReader API ===');
    if (typeof FileReader !== 'undefined') {
        log('✓ FileReader API is available', 'pass');
    } else {
        log('✗ FileReader API not available', 'fail');
    }

    // Test 5: Blob API
    log('\n=== Test 5: Blob API ===');
    try {
        var blob = new Blob(['test'], { type: 'application/octet-stream' });
        log('✓ Blob API is available', 'pass');
    } catch (e) {
        log('✗ Blob API error: ' + e.message, 'fail');
    }

    // Test 6: Check for common save sizes
    log('\n=== Test 6: Save Size Calculations ===');
    var sramSize = 32768; // 32KB SRAM
    var flash512Size = 65536; // 64KB Flash
    var flash1MSize = 131072; // 128KB Flash
    
    // Base64 increases size by ~33%
    var sramEncoded = Math.ceil(sramSize * 4 / 3);
    var flash512Encoded = Math.ceil(flash512Size * 4 / 3);
    var flash1MEncoded = Math.ceil(flash1MSize * 4 / 3);
    
    log('SRAM (32KB) -> ~' + (sramEncoded / 1024).toFixed(1) + 'KB encoded', 'info');
    log('Flash 512K (64KB) -> ~' + (flash512Encoded / 1024).toFixed(1) + 'KB encoded', 'info');
    log('Flash 1M (128KB) -> ~' + (flash1MEncoded / 1024).toFixed(1) + 'KB encoded', 'info');

    // Display results
    displayResults();
}

function displayResults() {
    var html = '';
    for (var i = 0; i < results.length; i++) {
        var result = results[i];
        html += '<div class="test ' + result.type + '">' + 
                result.message.replace(/\n/g, '<br>') + '</div>';
    }
    document.getElementById('results').innerHTML = html;
}

// Run tests on load
window.onload = runTests;
</script>

<h2>Manual Verification Steps</h2>
<ol>
    <li>Open the main GBA.js page (index.html)</li>
    <li>Load a GBA ROM file</li>
    <li>Open browser's Developer Console (F12)</li>
    <li>Watch for save-related messages:
        <ul>
            <li>"Savedata stored for [CODE]" - save was written</li>
            <li>"Savedata loaded for [CODE]" - save was read</li>
            <li>"No savedata found for [CODE]" - first time running game</li>
        </ul>
    </li>
    <li>Click "Store Savegame" button manually</li>
    <li>Refresh the page and reload the same ROM</li>
    <li>Verify save was loaded successfully</li>
    <li>Check localStorage in Developer Tools:
        <ul>
            <li>Application/Storage → Local Storage</li>
            <li>Look for keys like "com.endrift.gbajs.XXXX"</li>
        </ul>
    </li>
</ol>

<h2>Common Issues and Solutions</h2>
<ul>
    <li><strong>localStorage disabled</strong>: Enable in browser settings or use Download/Upload instead</li>
    <li><strong>Private browsing</strong>: localStorage may not persist between sessions</li>
    <li><strong>Quota exceeded</strong>: Clear old saves from localStorage</li>
    <li><strong>No cart code</strong>: ROM may not have proper header, using default "save" name</li>
</ul>

</body>
</html>
